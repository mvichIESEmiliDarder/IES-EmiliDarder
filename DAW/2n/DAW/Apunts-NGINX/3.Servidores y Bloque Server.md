# Servidores y Bloque `server` (Virtual Hosts ) en NGINX

El **bloque `server`** en NGINX es la implementación del concepto de **Virtual Host** o "servidor virtual". Permite que un único proceso de NGINX sirva **múltiples dominios o sitios web** de manera eficiente, optimizando los recursos de la máquina y las conexiones.

Un bloque `server` funciona como una **unidad lógica** que define cómo NGINX debe escuchar una combinación de puerto/IP y a qué nombre de dominio debe responder.

### 1\. La Directiva `server`

La directiva `server` es un **contenedor de bloque** (similar a `<VirtualHost>` en Apache) que encapsula toda la configuración específica de un sitio web.

**Sintaxis:**

NGINX

```nginx
server {
    # ... Directivas de configuración específicas para este sitio ...
}
```

El bloque `server` en sí mismo no especifica la IP o el puerto; eso lo hace la directiva **`listen`** contenida en su interior.

|Directiva Clave|Función Principal|
|---|---|
|**`listen`**|Indica la **dirección IP y el puerto** que este bloque debe monitorear y responder.|
|**`server_name`**|Define los **nombres de dominio** a los que responderá este bloque `server`.|

-----

## 2\. Directivas Esenciales Dentro del Bloque `server`

Dentro del contenedor `server`, se utilizan directivas para definir la identidad del sitio, el contenido y el comportamiento de la red:

|Directiva|Equivalencia Apache|Función|Ejemplo|
|---|---|---|---|
|**`listen`**|Parte de `<VirtualHost>`|Define el puerto y la IP donde NGINX aceptará peticiones para este sitio.|`listen 80;`|
|**`server_name`**|`ServerName` y `ServerAlias`|Define el **nombre(s) de dominio** con el que el servidor se identificará. Acepta múltiples valores separados por espacios.|`server_name www.ejemplo.com ejemplo.com;`|
|**`root`**|`DocumentRoot`|**Obligatoria.** Especifica la **ruta física** en el sistema de archivos donde residen los archivos base de este sitio web.|`root /var/www/ejemplo.com/public_html;`|
|**`access_log`**|`CustomLog`|Define dónde almacenar el archivo de registro de peticiones exitosas (accesos).|`access_log /var/log/nginx/ejemplo-access.log;`|
|**`error_log`**|`ErrorLog`|Define dónde almacenar el archivo de registro de errores del servidor para este sitio.|`error_log /var/log/nginx/ejemplo-error.log;`|

-----

## 3\. Tipos de Servidores Virtuales (Virtual Hosts)

NGINX es altamente eficiente en el manejo de Virtual Hosts, primando la configuración basada en el nombre.

### A. Virtual Hosts Basados en Nombre (`server_name`) (El más común)

Este es el método estándar y más eficiente. **Múltiples dominios** (ej. `ejemplo1.com`, `ejemplo2.com`) comparten la **misma dirección IP y puerto** (`listen 80;`).

  - **Mecanismo:** NGINX lee la cabecera `Host` de la petición del cliente y busca un bloque `server` cuyo **`server_name`** coincida. El primero que coincida será el que se utilice.

  - **Server por Defecto:** Si una petición llega al puerto (ej. 80) y el nombre de host solicitado **no coincide** con ningún `server_name` configurado, NGINX utiliza el **primer** bloque `server` que encuentra en ese puerto. Este se conoce como el servidor por defecto o *default server*.

    NGINX

    ```nginx
    listen 80 default_server; # Define explícitamente este bloque como el servidor por defecto
    server_name _;             # El guion bajo es un nombre de dominio que nunca existirá
    ```

### B. Virtual Hosts Basados en Dirección y Puerto

Aunque es menos común, NGINX puede distinguir entre sitios basándose en el puerto o la IP exacta, usando la directiva `listen`.

  - **Mecanismo:** NGINX decide qué `server` usar si la combinación IP:Puerto de la petición coincide con la directiva `listen`.

  - **Configuración clave:** La directiva `listen` especifica la IP exacta. Si no se especifica IP, asume todas las IPs.

    NGINX

    ```nginx
    server {
        listen 192.168.1.10:80; # Solo responde a esta IP
        server_name ejemplo_ip.com; 
        # ...
    }
    ```

-----

## 4\. Proceso de Activación (Sistemas Comunes)

La configuración de un Virtual Host en NGINX requiere una gestión manual de los archivos. NGINX no utiliza comandos como `a2ensite` / `a2dissite` de Apache, aunque la estructura de directorios es similar:

1.  **Creación:** El archivo de configuración (`ejemplo.com.conf`) se crea en el directorio **`sites-available`** (o `conf.d/`).

2.  **Activación:** Se crea un **enlace simbólico** (soft link) del archivo de configuración desde `sites-available` hacia el directorio **`sites-enabled`**.

    ```bash
    # Comando de activación en sistemas Linux:
    sudo ln -s /etc/nginx/sites-available/ejemplo.com.conf /etc/nginx/sites-enabled/
    ```

3.  **Verificación y Aplicación:** Antes de aplicar, se recomienda verificar la sintaxis de la configuración para evitar fallos:

    ```bash
    sudo nginx -t
    sudo systemctl reload nginx 
    ```

-----

## 5\. La Importancia del DNS y el Archivo `hosts`

Al igual que en Apache, el funcionamiento del Virtual Host basado en nombre depende de la **resolución del nombre de dominio**.

1.  El **DNS** público (o el archivo `hosts` local) debe traducir el nombre de dominio (`www.ejemplo.com`) a la dirección IP del servidor NGINX.
2.  NGINX recibe la solicitud en su IP, lee la cabecera `Host` (ej. `www.ejemplo.com`) y la compara con la directiva **`server_name`** para servir el contenido correcto.