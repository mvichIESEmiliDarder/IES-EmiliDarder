# Configuración del site https://www.siurells.local
El proceso se divide en tres partes principales:

1.  **Generación de la Clave Privada y la Solicitud de Certificado (CSR)** para el dominio.
2.  **Firma del CSR** con tu CA para generar el certificado.
3.  **Configuración de Apache** para usar el certificado.

-----

## 1. Generación de Clave y CSR para el Dominio

Primero necesitamos crear una clave privada y una Solicitud de Firma de Certificado (CSR) para `www.siurells.local` en nuestra AC.

### Paso 1.1: Crear la clave privada y el CSR

Ejecutamos el siguiente comando. Nos pedirá información que debemos completar, asegurándonos de que el campo **"Common Name" (CN)** sea exactamente el nombre de tu dominio: `www.siurells.local`.

```bash
openssl req -new -newkey rsa:2048 -nodes -keyout siurells.local.key -out siurells.local.csr
```

  * **`siurells.local.key`**: Será la clave privada del site (la guardamos de forma segura).
  * **`siurells.local.csr`**: Es la solicitud que debe de firmar la AC.

> **Importante:** Cuando nos pregunte por el **Common Name (e.g. server FQDN or YOUR name)**, debemos introducir **`www.siurells.local`**.

-----

## 2. Firma del CSR con la AC

Ahora usaremos nuestra AC para firmar la solicitud y emitir el *certificado final*. Asumimos que nuestra AC tiene los archivos `ca.crt` (certificado de la CA) y `ca.key` (clave privada de la CA) en un directorio, por ejemplo, `/root/myCA/`.

### Paso 2.1: Firmar el CSR

Ejecutamos el comando para firmar el CSR. Nos aseguramos de ajustar las rutas a los archivos de la AC si son diferentes.

```bash
openssl x509 -req -in siurells.local.csr -CA /root/myCA/ca.crt -CAkey /root/myCA/ca.key -CAcreateserial -out siurells.local.crt -days 365
```

  * **`siurells.local.crt`**: Este es el certificado SSL final para la web.
  * **`-days 365`**: Define la validez del certificado (un año, puedes ajustarlo).

Tras este paso, obtenemos tres archivos esenciales:

1.  **`siurells.local.key`** (Clave Privada del Servidor)
2.  **`siurells.local.crt`** (Certificado del Servidor)
3.  **`/root/myCA/ca.crt`** (Certificado de la Autoridad de Certificación)

-----

## 3. Configuración de Apache en Ubuntu 24.04

Ahora copiaremos los archivos y configuraremos el *VirtualHost* en Apache.

### Paso 3.1: Instalar y activar módulos SSL

Activamos el módulo SSL de Apache:

```bash
sudo a2enmod ssl
```

### Paso 3.2: Copiar los archivos a un directorio seguro

Creamos un directorio para nuestros certificados en Apache y copiamos los tres archivos:

```bash
# Creamos el directorio
sudo mkdir -p /etc/apache2/ssl/siurells.local

# Copiamos los archivos
sudo cp siurells.local.key /etc/apache2/ssl/siurells.local/
sudo cp siurells.local.crt /etc/apache2/ssl/siurells.local/
sudo cp /root/myCA/ca.crt /etc/apache2/ssl/siurells.local/ca.crt
```

### Paso 3.3: Crear el VirtualHost de SSL

Creamos un nuevo archivo de configuración para tu sitio con SSL (por ejemplo, `siurells.local-ssl.conf`).

```bash
sudo nano /etc/apache2/sites-available/siurells.local-ssl.conf
```

Pegamos y adaptamos la siguiente configuración. **Hay que asegurarse de que las rutas a los archivos SSLCertificateFile, SSLCertificateKeyFile y SSLCACertificateFile sean correctas.**

```apache
<VirtualHost *:443>
    ServerName www.siurells.local
    DocumentRoot /var/www/siurells.local/html # Ajustamos a la ruta real de tu web

    ErrorLog ${APACHE_LOG_DIR}/siurells.local-error.log
    CustomLog ${APACHE_LOG_DIR}/siurells.local-access.log combined

    # Configuración SSL/TLS
    SSLEngine on
    SSLCertificateFile    /etc/apache2/ssl/siurells.local/siurells.local.crt
    SSLCertificateKeyFile /etc/apache2/ssl/siurells.local/siurells.local.key
    SSLCACertificateFile  /etc/apache2/ssl/siurells.local/ca.crt # Certificado de la CA
</VirtualHost>
```

### Paso 3.4: Activar el sitio y recargar Apache

1.  **Habilitamos el VirtualHost:**

    ```bash
    sudo a2ensite siurells.local-ssl.conf
    ```

2.  **Verificamos la configuración de Apache:**

    ```bash
    sudo apache2ctl configtest
    # Debe decir: Syntax OK
    ```

3.  **Reiniciamos Apache** para aplicar los cambios:

    ```bash
    sudo systemctl restart apache2
    ```

-----

## 💡 Paso Adicional: Confiar en la CA

Dado que hemos usado una AC privada, los navegadores no la reconocerán automáticamente, por lo que veremos un error de seguridad (aunque la conexión es segura).

Para acceder sin errores, debemoss **instalar el certificado de tu CA (`/root/myCA/ca.crt`)** en el almacén de certificados **de nuestro sistema operativo o navegador** (el que usemos para acceder a `www.siurells.local`). Una vez hecho esto, el navegador confiará en nuestra AC y, por lo tanto, en el certificado de `siurells.local`.

## Paso Adicional 2: Hacer la redirección de HTTP a HTTPs
Para forzar la redirección automática de HTTP (`http://www.siurells.local:80`) a HTTPS (`https://www.siurells.local:443`) en Apache, debemoss modificar el archivo de configuración del *VirtualHost* que maneja las peticiones por el puerto 80.


## 1. ⚙️ Modificar el VirtualHost HTTP (Puerto 80)

### Paso 1.1: Añadir la directiva de redirección

Dentro del bloque `VirtualHost *:80`, añadimos la directiva `Redirect` para que cualquier solicitud entrante en HTTP se mueva inmediatamente a HTTPS.

```apache
<VirtualHost *:80>
    ServerName www.siurells.local
    ServerAlias siurells.local
    DocumentRoot /var/www/siurells.local/html # Opcional, pero buena práctica

    #🚨 Directiva clave: Redirección permanente (301) a HTTPS
    Redirect permanent / https://www.siurells.local/
</VirtualHost>
```

-----

### Paso 1.2: Activar el VirtualHost HTTP

Si el nuevo archivo del virtual host es `siurells.local.conf`, debemoss activarlo:

```bash
sudo a2ensite siurells.local.conf
```

### Paso 1.3: Verificar la configuración y reiniciar

1.  **Verificamos la sintaxis** para asegurarnos de que no hay errores:

    ```bash
    sudo apache2ctl configtest
    # Debe decir: Syntax OK
    ```

2.  **Reiniciamos Apache** para aplicar los cambios:

    ```bash
    sudo systemctl restart apache2
    ```

A partir de ahora, cuando un usuario intente acceder a `http://www.siurells.local`, Apache interceptará la petición en el puerto 80 e inmediatamente le enviará una respuesta al navegador para que intente la conexión utilizando el protocolo HTTPS en el puerto 443.
