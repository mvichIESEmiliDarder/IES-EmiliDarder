## Servidores Virtuales (Virtual Hosts) en Apache

Los **Virtual Hosts** son la característica de Apache que permite que un solo servidor (una única máquina con una dirección IP) sirva **múltiples dominios o sitios web** de manera independiente. Para el usuario final, cada sitio web parece estar en un servidor único y dedicado, aunque todos compartan los mismos recursos de _hardware_.

El corazón de esta configuración es la directiva **`<VirtualHost>`**.

### 1. La Directiva `<VirtualHost>`

La directiva `<VirtualHost>` es un **contenedor** que encapsula toda la configuración específica de un sitio web.

**Sintaxis:**

Apache

```
<VirtualHost [dirección_ip]:[puerto]>
    # ... Directivas de configuración específicas para este sitio ...
</VirtualHost>
```

El valor que acompaña a la etiqueta (ej. `*:80` o `192.168.1.10:80`) le indica a Apache a qué **dirección IP y puerto** debe responder este bloque de configuración.

|Valor Común|Significado|
|---|---|
|**`*:80`**|Responde a **todas las direcciones IP** asignadas al servidor y al puerto HTTP estándar (80). (Típico para Virtual Hosts basados en nombre).|
|**`192.168.1.10:80`**|Responde solo a peticiones dirigidas específicamente a la IP `192.168.1.10` en el puerto 80. (Típico para Virtual Hosts basados en IP).|

---

## 2. Directivas Esenciales Dentro del Bloque

Dentro del contenedor `<VirtualHost>`, se utilizan varias directivas para definir la identidad y ubicación del sitio:

|Directiva|Función|Ejemplo|
|---|---|---|
|**`DocumentRoot`**|**Obligatoria.** Especifica la **ruta física** en el sistema de archivos del servidor donde residen los archivos de este sitio web.|`DocumentRoot /var/www/ejemplo.com/public_html`|
|**`ServerName`**|**Obligatoria.** Define el **nombre de dominio principal** con el que el servidor se identificará para este sitio.|`ServerName www.ejemplo.com`|
|**`ServerAlias`**|**Opcional.** Permite especificar nombres de dominio **alternativos** (como la versión sin `www`) que también dirigirán al usuario a este mismo sitio.|`ServerAlias ejemplo.com`|
|**`ServerAdmin`**|**Opcional.** La dirección de correo electrónico del administrador del sitio (se muestra en las páginas de error).|`ServerAdmin admin@ejemplo.com`|
|**`ErrorLog` / `CustomLog`**|**Opcional/Recomendada.** Definen dónde se almacenarán los archivos de registro de errores y de acceso para este dominio.|`ErrorLog ${APACHE_LOG_DIR}/ejemplo-error.log`|
|**`<Directory>`**|**Opcional/Recomendada.** Contenedor usado para aplicar permisos y opciones de seguridad al `DocumentRoot` de este sitio.||

---

## 3. Tipos de Virtual Hosts

Apache puede distinguir entre sitios basándose en dos métodos principales:

### A. Virtual Hosts Basados en Nombre (Name-Based) (El más común)

Este es el método más utilizado y eficiente. **Múltiples dominios** (ej. `ejemplo1.com`, `ejemplo2.com`) comparten la **misma dirección IP y puerto** (`*:80`).

- **Mecanismo:** Cuando un cliente solicita una página, incluye el nombre de dominio en la cabecera HTTP (`Host: www.ejemplo1.com`). Apache lee esta cabecera y la compara con el valor de **`ServerName`** o **`ServerAlias`** de sus Virtual Hosts, cargando la configuración correspondiente.
    
- **Configuración clave:** El bloque `<VirtualHost>` debe usar el comodín `*` (asterisco) o la dirección IP del servidor, seguido del puerto (ej. `<VirtualHost *:80>`).
    

### B. Virtual Hosts Basados en IP (IP-Based)

En este método, cada sitio web está asociado a una **dirección IP diferente**.

- **Mecanismo:** El servidor debe tener configuradas múltiples direcciones IP. Apache decide qué sitio web servir basándose en la **dirección IP específica** a la que se envió la solicitud.
    
- **Configuración clave:** El bloque `<VirtualHost>` especifica la IP exacta (ej. `<VirtualHost 192.168.1.10:80>`). Esto es menos flexible, ya que requiere consumir una dirección IP pública por cada sitio.
    

---

## 4. Proceso de Activación (Debian/Ubuntu)

La configuración de un Virtual Host en sistemas basados en Debian/Ubuntu sigue un flujo de trabajo estándar:

1. **Creación:** El archivo de configuración (`ejemplo.com.conf`) se crea en el directorio **`sites-available`**.
    
2. **Activación:** Se utiliza el comando **`a2ensite`** (Apache 2 Enable Site), que crea un **enlace simbólico** del archivo de configuración desde `sites-available` hacia el directorio **`sites-enabled`**.
    
3. **Aplicación:** Se reinicia o recarga el servicio de Apache (ej. `sudo systemctl reload apache2`) para que lea y aplique la nueva configuración.
    

El proceso inverso para desactivar un sitio es **`a2dissite`**.

---

## 5. La Importancia del DNS y el Archivo `hosts`

Para que un Virtual Host basado en nombre funcione correctamente, es crucial que:

1. El nombre de dominio (`www.ejemplo.com`) se traduzca (resuelva) a la dirección IP del servidor Apache. Esto lo realiza el **DNS**.
    
2. Si estás probando sitios localmente o en una red privada sin DNS público, debes modificar el archivo **`hosts`** de tu equipo cliente (PC) para forzar la traducción localmente:
    
    ```
    192.168.56.3 ejemplo1.com
    192.168.56.3 ejemplo2.com
    ```
    
    Esto le dice a tu navegador: "Cuando intentes ir a `ejemplo1.com`, usa la IP `192.168.56.3`". Apache, al recibir la solicitud a la IP `192.168.56.3`, lee la cabecera _Host_ (`ejemplo1.com`) y utiliza el Virtual Host correcto.